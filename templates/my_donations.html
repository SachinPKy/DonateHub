{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <title>My Donations | DonateHub</title>

  <link rel="icon" href="{% static 'favicon.ico' %}">
  <link rel="apple-touch-icon" href="{% static 'images/apple-touch-icon.png' %}">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background: #f4f6f9;
    }
    .dashboard-title {
      font-weight: bold;
    }
    .status-badge {
      font-size: 0.85rem;
      padding: 6px 12px;
    }
    .tracking-btn {
      font-size: 0.75rem;
      padding: 4px 8px;
    }
    .donation-thumb {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #dee2e6;
      cursor: pointer;
    }
    .image-cell {
      text-align: center;
      min-width: 60px;
    }
    .gallery-modal .modal-dialog {
      max-width: 600px;
    }
    .gallery-image {
      max-height: 500px;
      object-fit: contain;
      width: 100%;
    }
    @media (max-width: 576px) {
      table { font-size: 0.85rem; }
      th, td { white-space: nowrap; }
    }
  </style>
</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/">DonateHub</a>
    <div class="collapse navbar-collapse justify-content-end" id="navbarMenu">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" href="/add/">Add Donation</a>
        </li>
      </ul>
      <form action="/accounts/logout/" method="post">
        {% csrf_token %}
        <button class="btn btn-outline-light btn-sm">Logout</button>
      </form>
    </div>
  </div>
</nav>

<div class="container mt-5 mb-5">
  <h2 class="dashboard-title text-primary mb-4">My Donations</h2>

  {% if donations %}
  <div class="table-responsive">
    <table class="table table-bordered table-hover bg-white shadow">
      <thead class="table-dark text-center">
        <tr>
          <th>#</th>
          <th>Images</th>
          <th>Category</th>
          <th>Location</th>
          <th>Pickup Date</th>
          <th>Status</th>
          <th>Tracking</th>
          <th>Receipt</th>
          <th>Submitted</th>
        </tr>
      </thead>
      <tbody>
        {% for donation in donations %}
        <tr>
          <td class="text-center">{{ forloop.counter }}</td>
          
          <td class="image-cell">
            {% with donation.images.all as images %}
              {% if images %}
                {% with images.first as img %}
                  {% if img and img.image %}
                    <img src="{{ img.image.url }}" class="donation-thumb"
                         data-bs-toggle="modal" data-bs-target="#imgModal{{ donation.id }}">
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                {% endwith %}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            {% endwith %}
          </td>
          
          <td>
            <strong>{{ donation.category }}</strong>
            <br><small class="text-muted">{{ donation.description|truncatewords:8 }}</small>
          </td>
          
          <td>
            {% if donation.area %}{{ donation.area }}, {% endif %}
            {% if donation.district %}{{ donation.district }}{% endif %}
            <br><small class="text-muted">{{ donation.state }}</small>
          </td>
          
          <td>{{ donation.pickup_date }}</td>

          <td class="text-center">
            {% if donation.status == "SUBMITTED" %}
              <span class="badge bg-warning status-badge">Submitted</span>
            {% elif donation.status == "CONFIRMED" %}
              <span class="badge bg-info status-badge">Confirmed</span>
            {% elif donation.status == "PICKUP_SCHEDULED" %}
              <span class="badge bg-primary status-badge">Pickup Scheduled</span>
            {% elif donation.status == "PICKED_UP" %}
              <span class="badge bg-secondary status-badge">Picked Up</span>
            {% elif donation.status == "IN_TRANSIT" %}
              <span class="badge bg-dark status-badge">In Transit</span>
            {% elif donation.status == "DELIVERED" %}
              <span class="badge bg-success status-badge">Delivered</span>
            {% elif donation.status == "COMPLETED" %}
              <span class="badge bg-success status-badge">Completed</span>
            {% elif donation.status == "CANCELLED" %}
              <span class="badge bg-danger status-badge">Cancelled</span>
            {% else %}
              <span class="badge bg-secondary status-badge">{{ donation.status }}</span>
            {% endif %}
          </td>

          <td class="text-center">
            <a href="{% url 'donation_tracking' donation.id %}"
               class="btn btn-sm btn-outline-primary tracking-btn">
              Track
            </a>
          </td>

          <td class="text-center">
            <a href="{% url 'receipt_pdf' donation.id %}" class="btn btn-sm btn-outline-success" target="_blank">
              Download
            </a>
          </td>

          <td>{{ donation.created_at|date:"d M Y" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="alert alert-info text-center">
    You have not made any donations yet.
    <a href="/add/" class="alert-link">Add a donation</a>
  </div>
  {% endif %}
</div>

{% for donation in donations %}
  {% with donation.images.all as images %}
    {% if images %}
      {% with images.first as img %}
        {% if img and img.image %}
        <div class="modal fade gallery-modal" id="imgModal{{ donation.id }}" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">{{ donation.category }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body text-center">
                <img src="{{ img.image.url }}" class="gallery-image" alt="Donation image">
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      {% endwith %}
    {% endif %}
  {% endwith %}
{% endfor %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
